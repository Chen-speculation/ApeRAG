import Header from '@/components/Header';
import { useModel, useParams,history } from '@umijs/max';
import { useEffect,useState,useRef } from 'react';
import kubechatComponent from './KubechatComponent.js';

export default () => {
  const { bots,getBot,getBots } = useModel('bot');
  const { botId } = useParams();
  const { user } = useModel('user');
  const [ bot, setBot ] = useState<any>();
  const [ readonly, setReadonly ] = useState(false);
  const ref = useRef();

  useEffect(() => {
    if (!bot||!ref.current) return;
    const x = ref.current;
    x.updateCaption(bot.title);
    // x.addEventListener('welcome', (e) => {
    //   console.log(e.message);
    // });
    // x.addEventListener('stream', (e) => {
    //   console.log(e.message);
    // });
    // x.addEventListener('beforeSpeak', (e) => {
    //   e.stopImmediatePropagation();
    //   // e.preventDefault();
    //   console.log(e.message);
    // });
  }, [bot, ref.current]);

  useEffect(()=>{
    if(!bots){
      getBots();
    }
    if(bot){
      setReadonly(bot.system && !user.is_admin);
    }else{
      setBot(getBot(botId));
    }
  },[bots,bot])

  useEffect(()=>{
    if(!bots){
      getBots();
      setBot(getBot(botId));
    }

    kubechatComponent.mount();

  },[history.location.pathname]);

  const customStyle = `
    :host{
      --bg-color-header: rgba(0,0,0,0.8);
    }
    .bot{box-shadow:none;z-index: 998;}
    .full-screen{z-index: 1000;}
    .hd,.bd,.ft{backdrop-filter: none;-webkit-backdrop-filter: none;}
    .bd,.ft{background:#1C1E27;}
    .adaptive .bot { height: calc(100vh - 130px)}
    .adaptive .full-screen.bot { height: 100vh}
    .topic .action button { background-size: 50%!important; border-radius:8px;}
  `;

  const protocol = window.location?.protocol;
  const sitePoint = protocol+'//'+window.location?.host;
  const API_Point = API_ENDPOINT && API_ENDPOINT!=='undefined' ? API_ENDPOINT : sitePoint;
  const endpoint = API_Point||'';
  const wserver = API_Point ? API_Point.replace(/^https?/i, protocol==='https:'?'wss':'ws') : '';
  const logo = `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgICA8Zz4KICAgIDx0aXRsZT5iYWNrZ3JvdW5kPC90aXRsZT4KICAgIDxyZWN0IGZpbGw9Im5vbmUiIGlkPSJjYW52YXNfYmFja2dyb3VuZCIgaGVpZ2h0PSI0MDIiIHdpZHRoPSI1ODIiIHk9Ii0xIiB4PSItMSIvPgogICAgPC9nPgogICAgPGc+CiAgICA8dGl0bGU+TGF5ZXIgMTwvdGl0bGU+CiAgICA8ZyBzdHJva2U9Im51bGwiIGlkPSJzdmdfNDMiPgogICAgPGcgc3Ryb2tlPSJudWxsIiB0cmFuc2Zvcm09Im1hdHJpeCgwLjEyOTM3NzQ3NDkyOTgzOTE3LDAsMCwwLjEyOTM3NzQ3NDkyOTgzOTE3LDUuMDgyMDQyNzczNDYxODEsNy41NjEwMjIxMTUyNzIwMDY1KSAiIGlkPSJzdmdfMzgiPgogICAgPHBhdGggc3Ryb2tlPSJudWxsIiBmaWxsPSJ3aGl0ZSIgZD0ibTE4LjYxNDMwMiwtMTUuNzE1NjQybC0xNC44MzQ4LDE0LjgzNDc3Yy0xMS4xMDk0NCw5LjY0MTcgLTE3Ljg5NTcxNywyMi41MjQyIC0xNy44OTU3MTcsMzYuNjc1NWMwLDI5Ljg4MjMgMzAuMjU5ODE3LDU0LjEwNjUgNjcuNTg3MTE3LDU0LjEwNjVjMzcuMzI3NSwwIDY3LjU4NzUsLTI0LjIyNDIgNjcuNTg3NSwtNTQuMTA2NWMwLC0xNC4xNTEyIC02Ljc4NywtMjcuMDMzNSAtMTcuODk2LC0zNi42NzUxbC0xNC44MzUsLTE0LjgzNTE0Yy0zLjU2MywtMy41NjMxOSAtOC4zOTU4LC01LjU2NDk3MSAtMTMuNDM0OSwtNS41NjQ5NzFsLTQyLjg0MzIsMGMtNS4wMzkxLDAgLTkuODcxOCwyLjAwMTc3MSAtMTMuNDM1LDUuNTY0OTQxem0zLjAxMjMsMjQuNDg1MTdjMi4yNjk5LC00LjA5ODYgNi40MzQ4LC0xMS42MTkgMTIuMjAwMywtMTEuNjE5bDM3Ljc2NjQsMGMzLjIxODgsLTAuNTAwNyAxMC44MTQ5LDEuMjg3NiAxNS40NTAxLDEyLjQ0NThjMC4xNzgsMC40MjgzIDAuMzY2LDAuODc4NiAwLjU2MywxLjM0OWM1Ljg0OCwxMy45NjU4IDE5LjExMyw0NS42NDQ1IC0xOC4zNzM1LDQ1LjY0NDVsLTM1LjQwNiwwYy0xMi45NDY1LC0wLjE0MzEgLTMzLjYwMzYsLTkuNzQyMSAtMTIuNjYwMywtNDYuOTkzNWMwLjE0MzQsLTAuMjU1MiAwLjI5NjgsLTAuNTMyMiAwLjQ2LC0wLjgyNjh6IiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGZpbGwtcnVsZT0iZXZlbm9kZCIgaWQ9InN2Z180MSIvPgogICAgPHBhdGggc3Ryb2tlPSJudWxsIiBmaWxsPSJ3aGl0ZSIgZD0ibTMxLjEyODYwMiwyMC41NjA4MjhjMC4yNzk2LC0yLjQ1OTYgMi4zNjA3LC00LjMxNzUgNC44MzYxLC00LjMxNzVjMi40NzU0LDAgNC41NTY1LDEuODU3OSA0LjgzNjEsNC4zMTc1bDAuNjIzMiw1LjQ4MTRjMC4wNTk3LDAuNTI1NCAwLjA1OTcsMS4wNTYgMCwxLjU4MTRsLTAuNjIzMiw1LjQ4MTRjLTAuMjc5NiwyLjQ1OTYgLTIuMzYwNyw0LjMxNzUgLTQuODM2MSw0LjMxNzVjLTIuNDc1NCwwIC00LjU1NjUsLTEuODU3OSAtNC44MzYxLC00LjMxNzVsLTAuNjIzMiwtNS40ODE0Yy0wLjA1OTcsLTAuNTI1NCAtMC4wNTk3LC0xLjA1NiAwLC0xLjU4MTRsMC42MjMyLC01LjQ4MTR6IiBpZD0ic3ZnXzQwIi8+CiAgICA8cGF0aCBzdHJva2U9Im51bGwiIGZpbGw9IndoaXRlIiBkPSJtNjkuNjU5ODAyLDIwLjU2MDgyOGMwLjI3OTcsLTIuNDU5NiAyLjM2MDgsLTQuMzE3NSA0LjgzNjIsLTQuMzE3NWMyLjQ3NTMsMCA0LjU1NjUsMS44NTc5IDQuODM2MSw0LjMxNzVsMC42MjMyLDUuNDgxNGMwLjA1OTcsMC41MjU0IDAuMDU5NywxLjA1NiAwLDEuNTgxNGwtMC42MjMyLDUuNDgxNGMtMC4yNzk2LDIuNDU5NiAtMi4zNjA4LDQuMzE3NSAtNC44MzYxLDQuMzE3NWMtMi40NzU0LDAgLTQuNTU2NSwtMS44NTc5IC00LjgzNjIsLTQuMzE3NWwtMC42MjMxLC01LjQ4MTRjLTAuMDU5OCwtMC41MjU0IC0wLjA1OTgsLTEuMDU2IDAsLTEuNTgxNGwwLjYyMzEsLTUuNDgxNHoiIGlkPSJzdmdfMzkiLz4KICAgIDwvZz4KICAgIDwvZz4KICAgIDwvZz4KICAgIDwvc3ZnPg==`;
  const likeIcon = `data:image/svg+xml;base64,PHN2ZyB0PSIxNzAwMTUyMzQ5NzI1IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjgwNTEiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHBhdGggZD0iTTg1LjMzMzMzMyA5NjBhNDIuNjY2NjY3IDQyLjY2NjY2NyAwIDAgMS00Mi42NjY2NjYtNDIuNjY2NjY3VjQ2OS4zMzMzMzNhNDIuNjY2NjY3IDQyLjY2NjY2NyAwIDAgMSA0Mi42NjY2NjYtNDIuNjY2NjY2aDE3MC42NjY2NjdhNDIuNjY2NjY3IDQyLjY2NjY2NyAwIDAgMSA0Mi41NiAzOS41MzA2NjYgMTA3Ljk0NjY2NyAxMDcuOTQ2NjY3IDAgMCAwIDMwLjIwOC0xMi41ODY2NjYgMTAwLjA1MzMzMyAxMDAuMDUzMzMzIDAgMCAwIDguMjc3MzMzLTUuNzE3MzM0IDEzMi40OCAxMzIuNDggMCAwIDAgMTkuMi0xOC4yMTg2NjYgMTczLjcxNzMzMyAxNzMuNzE3MzMzIDAgMCAwIDI2LjE3Ni00MC40NDhsMTMzLjI0OC0yOTkuODgyNjY3QTQyLjY2NjY2NyA0Mi42NjY2NjcgMCAwIDEgNTU0LjY2NjY2NyA2NGg2NC4xMDY2NjZBMTA2LjcwOTMzMyAxMDYuNzA5MzMzIDAgMCAxIDcyNS4zMzMzMzMgMTcwLjUxNzMzM2E0Mi42NjY2NjcgNDIuNjY2NjY3IDAgMCAxLTAuNjgyNjY2IDcuNjE2TDY5MS4xMTQ2NjcgMzYyLjY2NjY2N2gxNzQuMTIyNjY2YzcyLjc4OTMzMyAwIDEyNS40ODI2NjcgNjAuMzczMzMzIDExNC42ODggMTMxLjg0LTAuODc0NjY3IDEwLjE1NDY2Ny0zLjM0OTMzMyAyNy4zNDkzMzMtOC4yMTMzMzMgNTEuNTg0LTguNDQ4IDQxLjg5ODY2Ny0yMS42NzQ2NjcgOTEuODYxMzMzLTQwLjc0NjY2NyAxNDkuOTA5MzMzLTIuMDI2NjY3IDYuMTAxMzMzLTQuMDUzMzMzIDEyLjEzODY2Ny02LjEyMjY2NiAxOC4xMzMzMzMtMTguMzQ2NjY3IDUzLjMxMi0zOC4xMDEzMzMgOTkuOTA0LTU3LjkyIDEzOS41Mi0xMS43NTQ2NjcgMjMuNDY2NjY3LTIxLjE4NCAzOS45Nzg2NjctMjcuMTM2IDQ5LjI4QzgyMC4yMDI2NjcgOTM1Ljk1NzMzMyA3NzguMTMzMzMzIDk2MCA3MzkuNjI2NjY3IDk2MEg4NS4zMzMzMzN6IG0yMTMuMzMzMzM0LTg1LjMzMzMzM2g0NDAuOTZjOC40MjY2NjcgMCAyMi43NDEzMzMtOC4yNTYgMjYuNzk0NjY2LTE1LjMxNzMzNGwxLjE3MzMzNC0xLjkyYzAuODUzMzMzLTEuMzQ0IDIuODU4NjY3LTQuNTg2NjY3IDUuODAyNjY2LTkuNzI4IDUuMTItOC45Mzg2NjcgMTAuOTIyNjY3LTE5LjY5MDY2NyAxNy4yMTYtMzIuMjM0NjY2IDE4LjE3Ni0zNi4zMzA2NjcgMzYuNDM3MzMzLTc5LjQ0NTMzMyA1My41NDY2NjctMTI5LjEzMDY2NyAxLjkyLTUuNjEwNjY3IDMuODQtMTEuMjY0IDUuNzE3MzMzLTE3LjAwMjY2NyAxOC4wMjY2NjctNTQuODQ4IDMwLjQyMTMzMy0xMDEuNTQ2NjY3IDM4LjE4NjY2Ny0xNDAuMDc0NjY2IDIuNjQ1MzMzLTEzLjIyNjY2NyA0LjU0NC0yNC40MDUzMzMgNS44MDI2NjctMzMuNTU3MzM0IDAuNzA0LTUuMTQxMzMzIDEuMDI0LTguMjU2IDEuMTA5MzMzLTkuMzY1MzMzbDAuNDY5MzMzLTMuOTA0YzMuMzI4LTE5Ljk0NjY2Ny05LjE1Mi0zNC40MzItMzAuMjA4LTM0LjQzMkg2NDBhNDIuNjY2NjY3IDQyLjY2NjY2NyAwIDAgMS00MS45ODQtNTAuMzA0bDQxLjgxMzMzMy0yMjkuOTczMzMzQTIxLjQxODY2NyAyMS40MTg2NjcgMCAwIDAgNjE4Ljc1MiAxNDkuMzMzMzMzSDU4Mi40bC0xMjEuMjM3MzMzIDI3Mi43NjhjLTcuMDQgMTcuMDQ1MzMzLTIwLjIwMjY2NyA0MC4yNzczMzMtNDAuNjE4NjY3IDYzLjY4LTkuNTc4NjY3IDEwLjk4NjY2Ny0yMC4wNTMzMzMgMjAuOTkyLTMxLjUwOTMzMyAyOS44MDI2NjctNS4wMzQ2NjcgMy44NC0xMC4yMTg2NjcgNy40MjQtMTUuNTUyIDEwLjY4OGExOTMuNjQyNjY3IDE5My42NDI2NjcgMCAwIDEtNjMuNTczMzM0IDI0LjgxMDY2NyAyMDQuMTgxMzMzIDIwNC4xODEzMzMgMCAwIDEtMTEuMjQyNjY2IDEuOTQxMzMzVjg3NC42NjY2Njd6IG0tMTcwLjY2NjY2NyAwaDg1LjMzMzMzM1Y1MTJIMTI4djM2Mi42NjY2Njd6IiBmaWxsPSIjZmZmZmZmIiBwLWlkPSI4MDUyIiBkYXRhLXNwbS1hbmNob3ItaWQ9ImEzMTN4LnNlYXJjaF9pbmRleC4wLmk3LjczODgzYTgxSlF2NjA0IiBjbGFzcz0ic2VsZWN0ZWQiPjwvcGF0aD48L3N2Zz4=`;
  const dislikeIcon = 'data:image/svg+xml;base64,PHN2ZyB0PSIxNzAwMTUyMjE2ODg0IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9Ijc4MDEiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHBhdGggZD0iTTkzOS4zMTQyODYgNDg3LjJjNC4xMTQyODYtMTMuNzE0Mjg2IDYuMTcxNDI5LTI3Ljg4NTcxNCA2LjE3MTQyOC00Mi4yODU3MTQgMC0zMi4zNDI4NTctMTAuNjI4NTcxLTYzLjQyODU3MS0yOS44Mjg1NzEtODguOCA0LjExNDI4Ni0xMy43MTQyODYgNi4xNzE0MjktMjcuODg1NzE0IDYuMTcxNDI4LTQyLjI4NTcxNSAwLTMyLjM0Mjg1Ny0xMC42Mjg1NzEtNjMuNDI4NTcxLTI5LjgyODU3MS04OC44IDQuMTE0Mjg2LTEzLjcxNDI4NiA2LjE3MTQyOS0yNy44ODU3MTQgNi4xNzE0MjktNDIuMjg1NzE0IDAtNTguOTcxNDI5LTM1LjA4NTcxNC0xMTIuMTE0Mjg2LTg5LjQ4NTcxNS0xMzUuMzE0Mjg2YTc1LjU0Mjg1NyA3NS41NDI4NTcgMCAwIDAtMzAuMjg1NzE0LTYuMTcxNDI4SDkxLjQyODU3MWMtMjAuMjI4NTcxIDAtMzYuNTcxNDI5IDE2LjM0Mjg1Ny0zNi41NzE0MjggMzYuNTcxNDI4djQxNmMwIDIwLjIyODU3MSAxNi4zNDI4NTcgMzYuNTcxNDI5IDM2LjU3MTQyOCAzNi41NzE0MjloMTQ3Ljc3MTQyOWw5OC4wNTcxNDMgMzU1LjJDMzUzLjAyODU3MSA5NDIuODU3MTQzIDQwNS42IDk4Mi44NTcxNDMgNDY1LjAyODU3MSA5ODIuODU3MTQzYzMzLjk0Mjg1NyAwIDY1LjYtMTMuNDg1NzE0IDg5LjAyODU3Mi0zOC4xNzE0MjkgMjMuNDI4NTcxLTI0LjU3MTQyOSAzNS40Mjg1NzEtNTYuOCAzMy43MTQyODYtOTAuNzQyODU3bC02Ljg1NzE0My0xNDAuNDU3MTQzaDI3NC4xNzE0MjhjMTMuODI4NTcxIDAgMjcuMzE0Mjg2LTMuNjU3MTQzIDM5LjItMTAuNjI4NTcxIDQ2LjE3MTQyOS0yNi44NTcxNDMgNzQuODU3MTQzLTc1LjU0Mjg1NyA3NC44NTcxNDMtMTI2Ljg1NzE0MyAwLTMyLjM0Mjg1Ny0xMC42Mjg1NzEtNjMuNDI4NTcxLTI5LjgyODU3MS04OC44ek0xMzcuMTQyODU3IDQ0OFYxMjMuNDI4NTcxaDkyLjU3MTQyOXYzMjQuNTcxNDI5aC05Mi41NzE0Mjl6IG03MTYuOCAxODMuMzE0Mjg2SDQ5NC42Mjg1NzFsMTAuOTcxNDI5IDIyNi43NDI4NTdjMC42ODU3MTQgMTMuNi01LjM3MTQyOSAyNi40LTE2LjY4NTcxNCAzNC44NTcxNDMtNi45NzE0MjkgNS4xNDI4NTctMTUuNTQyODU3IDcuNzcxNDI5LTI0LjExNDI4NiA3LjY1NzE0M2E1MC42MDU3MTQgNTAuNjA1NzE0IDAgMCAxLTQ4LjIyODU3MS0zNi45MTQyODZMMzAyLjg1NzE0MyA0NTEuNjU3MTQzVjEyMy40Mjg1NzFoNDc0Ljc0Mjg1N2E2NC45NzE0MjkgNjQuOTcxNDI5IDAgMCAxIDM4LjQgNTkuMmMwIDExLjA4NTcxNC0yLjYyODU3MSAyMS42LTcuODg1NzE0IDMxLjJsLTE1Ljg4NTcxNSAyOS4wMjg1NzIgMjUuMDI4NTcyIDIxLjcxNDI4NmE2NC44Njg1NzEgNjQuODY4NTcxIDAgMCAxIDIyLjQgNDkuMTQyODU3YzAgMTEuMDg1NzE0LTIuNjI4NTcxIDIxLjYtNy44ODU3MTQgMzEuMmwtMTUuODg1NzE1IDI5LjAyODU3MSAyNS4wMjg1NzIgMjEuNzE0Mjg2YTY0Ljg2ODU3MSA2NC44Njg1NzEgMCAwIDEgMjIuNCA0OS4xNDI4NTdjMCAxMS4wODU3MTQtMi42Mjg1NzEgMjEuNi03Ljg4NTcxNSAzMS4ybC0xNiAyOS4xNDI4NTcgMjUuMDI4NTcyIDIxLjcxNDI4NmE2NC44Njg1NzEgNjQuODY4NTcxIDAgMCAxIDIyLjQgNDkuMTQyODU3YzAgMjEuODI4NTcxLTEyLjU3MTQyOSA0Mi44NTcxNDMtMzIuOTE0Mjg2IDU1LjMxNDI4NnoiIHAtaWQ9Ijc4MDIiIGRhdGEtc3BtLWFuY2hvci1pZD0iYTMxM3guc2VhcmNoX2luZGV4LjAuaTEuNzM4ODNhODFKUXY2MDQiIGNsYXNzPSIiIGZpbGw9IiNmZmZmZmYiPjwvcGF0aD48L3N2Zz4=';

  return (
    <div className="workspace chat">
      <Header goback={true} page='chat-bot' action={!readonly}/>
      <div className="bd">
        <div className="content" style={{height:'100%'}}>
          <kube-chat ref={ref} botid={botId} caption={bot?.title} sessionid={user?.sub} mode="adaptive" logo={logo} likeicon={likeIcon} dislikeicon={dislikeIcon} customstyle={customStyle} disableuploadimage={true} disablespeech={true} endpoint={endpoint} wserver={wserver} />
        </div>
      </div>
    </div>
  );
};
name: Build and Deploy with KinD
on: [pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Create KinD config
      run: |
        cat > kind-config.yaml <<EOF
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        nodes:
        - role: control-plane
          kubeadmConfigPatches:
          - |
            kind: InitConfiguration
            nodeRegistration:
              kubeletExtraArgs:
                node-labels: "ingress-ready=true"
          extraPortMappings:
          - containerPort: 8000
            hostPort: 8000
            protocol: TCP
          - containerPort: 3000
            hostPort: 3000
            protocol: TCP
        - role: worker
        - role: worker
        EOF

    - name: Create KinD cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: test-cluster
        config: kind-config.yaml

    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Install KubeBlocks
      run: |
        chmod +x ./deploy/databases/01-prepare.sh
        ./deploy/databases/01-prepare.sh

    - name: Install Databases
      run: |
        chmod +x ./deploy/databases/02-install-database.sh
        ./deploy/databases/02-install-database.sh
        kubectl get pods -o wide

    - name: Build local images
      run: |
        make build-local VERSION=dev-latest

    - name: Load images to KinD
      run: |
        make load-images-to-kind VERSION=dev-latest KIND_CLUSTER_NAME=test-cluster

    - name: Install ApeRAG application
      run: |
        helm install aperag ./deploy/aperag \
          --set image.tag=dev-latest \
          --set frontend.image.tag=dev-latest \
          --wait --timeout=10m

    - name: Wait for all pods to be ready
      run: |
        echo "Waiting for all pods to be ready..."
        kubectl wait --for=condition=ready pod --all --timeout=600s
        echo "Checking deployment status..."
        kubectl get pods -o wide
        kubectl get svc
        

    - name: Port forward services
      run: |
        echo "Starting port forwarding..."
        kubectl port-forward svc/aperag 8000:8000 &
        kubectl port-forward svc/aperag-frontend 3000:3000 &
        sleep 15
        echo "Verifying services are accessible..."
        curl -f http://localhost:8000/health || echo "Backend health check failed"
        curl -f http://localhost:3000 || echo "Frontend check failed"

    - name: Run E2E tests
      run: |
        make e2e-test

    # 失败时的调试步骤
    - name: Debug information on failure
      if: failure()
      run: |
        echo "=== Cluster Information ==="
        kubectl cluster-info
        echo "=== All Pods ==="
        kubectl get pods --all-namespaces -o wide
        echo "=== All Services ==="
        kubectl get svc --all-namespaces
        echo "=== Events ==="
        kubectl get events --sort-by=.metadata.creationTimestamp
        echo "=== Pod Descriptions ==="
        kubectl describe pods
        echo "=== Pod Logs ==="
        for pod in $(kubectl get pods -o jsonpath='{.items[*].metadata.name}'); do
          echo "--- Logs for $pod ---"
          kubectl logs $pod --tail=100 || true
        done
        echo "=== Helm Status ==="
        helm list --all-namespaces
        helm status aperag || true

    # 启用 SSH 访问进行调试
    - name: Setup tmate session for debugging
      if: failure()
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true
        github-token: ${{ secrets.GITHUB_TOKEN }}
      timeout-minutes: 30